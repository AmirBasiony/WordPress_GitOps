name: Terraform Infrastructure Management with Ansible

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment (dev, stage, prod)'
        required: true
        type: choice
        options:
          - dev
          - stage
          - prod
      action:
        description: 'Choose action (build or destroy)'
        required: true
        type: choice
        options:
          - build
          - destroy

permissions:
  id-token: write
  contents: read


jobs:
  terraform:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout the code
        uses: actions/checkout@v2

      # Set up Terraform (version 1.6.0 or higher)
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2  # Use v2 for the latest version support
        with:
          terraform_version: ">= 1.6.0"  # Ensure the version is at least 1.6.0

      # Configure AWS credentials using OIDC
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          
      # Set the backend config for environment
      - name: Set backend config for environment
        run: |
          echo "TF_BACKEND_CONFIG=backend/${{ github.event.inputs.environment }}.hcl" >> $GITHUB_ENV

      # Initialize Terraform with the dynamic backend configuration
      - name: Terraform init
        working-directory: ./wordpress-terraform  # Make sure to run Terraform in the correct directory
        run: terraform init -reconfigure -backend-config=${{ env.TF_BACKEND_CONFIG }}

      # Install Ansible and dependencies
      - name: Install Ansible and collections
        run: |
          sudo apt update
          sudo apt install -y python3-pip
          pip3 install ansible
          ansible-galaxy collection install -r wordpress-ansible/requirements.yml --force

      # Set Cloudflare API token environment variable for Terraform
      - name: Set Cloudflare API Token for Terraform
        run: echo "TF_VAR_cloudflare_api_token=${{ secrets.CLOUDFLARE_API_TOKEN }}" >> $GITHUB_ENV

      # Terraform plan or apply based on action input
      - name: Terraform plan or apply based on action
        working-directory: ./wordpress-terraform  # Make sure to run Terraform in the correct directory
        run: |
          if [ "${{ github.event.inputs.action }}" == "build" ]; then
            terraform plan -var="environment=${{ github.event.inputs.environment }}"
            terraform apply -auto-approve -var="environment=${{ github.event.inputs.environment }}"
          elif [ "${{ github.event.inputs.action }}" == "destroy" ]; then
            terraform plan -destroy -var="environment=${{ github.event.inputs.environment }}"
            terraform destroy -auto-approve -var="environment=${{ github.event.inputs.environment }}"
          fi

      # Output Terraform outputs
      - name: Terraform output
        if: ${{ github.event.inputs.action == 'build' }}
        working-directory: ./wordpress-terraform  # Make sure to run Terraform in the correct directory
        run: terraform output

    #   # Run Ansible playbook if the action is build
    #   - name: Run Ansible Playbook
    #     if: ${{ github.event.inputs.action == 'build' }}
    #     working-directory: ./wordpress-ansible  # Make sure to run Ansible in the correct directory
    #     run: |
    #       ansible-playbook -i inventory.ini wordpress.yml
