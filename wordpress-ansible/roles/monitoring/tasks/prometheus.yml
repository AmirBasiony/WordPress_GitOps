---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true

- name: Install Prometheus
  ansible.builtin.apt:
    name: prometheus
    state: present

- name: Render Prometheus config (scrape web nodes)
  ansible.builtin.template:
    src: prometheus.yml.j2
    dest: "{{ prometheus_config_file }}"
    owner: root
    group: root
    mode: "0644"
  notify: restart prometheus

- name: Apply restarts now
  ansible.builtin.meta: flush_handlers

- name: Validate Prometheus config
  ansible.builtin.command: promtool check config {{ prometheus_config_file }}
  changed_when: false

- name: Ensure Prometheus port is listening
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ prometheus_port }}"
    timeout: 60
