server {
  listen 80 default_server;
  server_name {{ wp_domain }};

  root {{ wp_root }};
  index index.php index.html;

  location = /health {
  add_header Content-Type text/plain;
  return 200 "ok\n";
  }
  

  location ~ ^/health$ {
    add_header Content-Type text/plain;
    return 200 "ok\n";
  }


  # --- Trust forwarded headers (ALB -> Nginx) ---
  set_real_ip_from {{ vpc_cidr }};
  real_ip_header X-Forwarded-For;
  real_ip_recursive on;

  # Determine original scheme from ALB header (fallback to nginx scheme)
  set $forwarded_proto $http_x_forwarded_proto;
  if ($forwarded_proto = "") { set $forwarded_proto $scheme; }

  # Also compute HTTPS flag properly for PHP/WordPress
  set $https_flag "";
  if ($forwarded_proto = "https") { set $https_flag "on"; }

  location / {
    try_files $uri $uri/ /index.php?$args;
  }

  location ~ \.php$ {
    include snippets/fastcgi-php.conf;
    fastcgi_pass unix:/run/php/php8.1-fpm.sock;

    fastcgi_param HTTP_HOST              $http_host;
    fastcgi_param HTTP_X_FORWARDED_HOST  $http_host;
    fastcgi_param HTTP_X_FORWARDED_PROTO $forwarded_proto;
    fastcgi_param HTTP_X_FORWARDED_FOR   $proxy_add_x_forwarded_for;

    # Correct HTTPS behavior for WordPress behind ALB TLS termination
    fastcgi_param HTTPS $https_flag;
  }
}
