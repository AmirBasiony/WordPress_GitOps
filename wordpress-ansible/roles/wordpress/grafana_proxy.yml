- name: Gather facts for monitoring host
  ansible.builtin.setup:
  delegate_to: "{{ groups['monitoring'][0] }}"
  delegate_facts: true
  run_once: true
  when: enable_monitoring | bool

- name: Set Grafana upstream per host (localhost on monitoring, else monitoring private IP)
  ansible.builtin.set_fact:
    grafana_upstream: >-
      {{ '127.0.0.1'
         if inventory_hostname == groups['monitoring'][0]
         else hostvars[groups['monitoring'][0]].ansible_default_ipv4.address }}
  when: enable_monitoring | bool

- name: Ensure /grafana/ reverse proxy is consistent on all web nodes (no redirect loop)
  ansible.builtin.blockinfile:
    path: /etc/nginx/sites-available/wordpress
    marker: "# {mark} ANSIBLE GRAFANA SUBPATH"
    insertafter: "index index.php index.html;"
    block: |
      location = /grafana {
        return 301 /grafana/;
      }

      location /grafana/ {
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        proxy_set_header X-Forwarded-Proto $forwarded_proto;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Prefix /grafana;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # IMPORTANT: hit Grafana on its subpath, not /
        proxy_pass http://{{ grafana_upstream }}:3000/grafana/;
      }
  notify: wordpress | validate and reload nginx
  when: enable_monitoring | bool
  tags: [grafana_proxy]
